% This etocx package aims to be a simple front-end for basic
% use of the etoc package.  Best if loaded after other
% packages.  Package Options: onedeep, twodeep, threedeep
% truncate the tocs at fixed relative depth.
% AJR, http://orcid.org/0000-0001-8930-1552
% with help from JFB, March 2019
\def\fileversion{0.3}
\def\filedate{2025/01/08}
\typeout{-- Package `etocx' \fileversion\space <\filedate> --}
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{etocx}[\filedate\space\fileversion]

% process options
% The default is to truncate all tocs at tocdepth. However,
% these options truncate tocs at fixed relative depth.
% Perhaps twodeep is generally best.
\def\Xetocdeep{9} % Default is truncated at tocdepth
\DeclareOption{onedeep}{\def\Xetocdeep{1}}
\DeclareOption{twodeep}{\def\Xetocdeep{2}}
\DeclareOption{threedeep}{\def\Xetocdeep{3}}
\ProcessOptions

% Build upon the etoc package
\typeout{-- `etocx.sty' requires the `etoc' package --}
\usepackage{etoc}

% try to identify article classes
\newif\ifXetocChaps
\XetocChapstrue
\@ifclassloaded{refart}{\XetocChapsfalse}{}
\@ifclassloaded{article}{\XetocChapsfalse}{}
\@ifclassloaded{scrartcl}{\XetocChapsfalse}{}
\@ifclassloaded{extarticle}{\XetocChapsfalse}{}
\ifXetocChaps\def\XetocHead{% chapter class
      \chapter*{Contents}\ifcase\Xetocdeep
      \or\etocsettocdepth{chapter}
      \or\etocsettocdepth{section}
      \else\fi}
      \typeout{****** etocx.sty: class with chapters}
   \else\def\XetocHead{% section class
      \section*{Contents}\ifcase\Xetocdeep
      \or\etocsettocdepth{section}
      \or\etocsettocdepth{subsection}
      \else\fi}
      \typeout{****** etocx.sty: class without chapters, only sections}
   \fi


\newcommand\XEtocheader{% from article.cls
\typeout{+++++++++ etocx.sty: this is XEtocheader}%?????????
    \@startsection{subsubsection}{3}{\z@}%
    {-3.25ex\@plus -1ex \@minus -.2ex}%
    {1.5ex \@plus .2ex}%
    {\normalfont\normalsize\itshape}}

\etocchecksemptiness% required for following to work
%******************************************************************************
% HACK (JFB, March 2 2019)
% attention this hack may become obsolete in future etoc versions
\let\Etoc@setemptytocboolORIGINAL\Etoc@checksemptiness% was \Etoc@setemptytocbool
\def\Etoc@checksemptiness% was \Etoc@setemptytocbool
{% Hack
    \Etoc@setemptytocboolORIGINAL
%    \global\let\OUR@ETOC@LOCALTOP\Etoc@localtop
% JFB 12/3/2019 replaces above line with the following
    \ifdefined\Etoc@localtop % etoc <1.09
        \global\let\OUR@ETOC@LOCALTOP\Etoc@localtop
   \else % etoc >=1.09
        \global\let\OUR@ETOC@LOCALTOP\etoclocaltop
   \fi
}
\def\OUR@ETOC@LOCALTOP{-\thr@@}
% this next is only needed due to the way the \ifcase are done next
\def\SHIFTED@ETOC@LOCALTOP{\numexpr\OUR@ETOC@LOCALTOP+5\relax}% was +1
\def\etoclocaltop{-\thr@@}% was \Etoc@localtop{-\thr@@}% just to be safe
% The \SHIFTED@ETOC@LOCALTOP is used below
%*******************************************************************************
% Set basic format of the various contents
\ifcase\Xetocdeep
\or%
\typeout{*********** etocx.sty one deep}%??????????????
\setcounter{tocdepth}{5}%need to store deep info (JFB no wrong) AJR needs it?
\etocsettocstyle{% one deep
  \ifcase\SHIFTED@ETOC@LOCALTOP\section*{Part contents}\etocsettocdepth{chapter}%
  \or\subsection*{Chapter contents}\etocsettocdepth{section}%
  \or\XEtocheader*{Section contents}\etocsettocdepth{subsection}%
  \or\XEtocheader*{Subsection contents}\etocsettocdepth{subsubsection}%
  \or\XEtocheader*{Subsubsection contents}\etocsettocdepth{paragraph}%
  \or\etocsettocdepth{paragraph}% a bit strange?? AJR Nov 2018
  \or%empty
  \or%empty
  \else\XetocHead%
  \fi
  \par}{\bigskip\noindent}
\or%
\typeout{*********** etocx.sty two deep}
\setcounter{tocdepth}{5}%need to store deep info (JFB no wrong) AJR needs it?
\etocsettocstyle{% two deep
  \ifcase\SHIFTED@ETOC@LOCALTOP\section*{Part contents}\etocsettocdepth{section}%
  \or\subsection*{Chapter contents}\etocsettocdepth{subsection}%
  \or\XEtocheader*{Section contents}\etocsettocdepth{subsubsection}%
  \or\XEtocheader*{Subsection contents}\etocsettocdepth{paragraph}%
  \or\XEtocheader*{Subsubsection contents}\etocsettocdepth{subparagraph}%
  \or%empty
  \or%empty
  \else\XetocHead%
  \fi\par}{\bigskip\noindent}
\else%
\typeout{*********** etocx.sty default case deep}%????
\etocsettocstyle{% default case
  \ifcase\SHIFTED@ETOC@LOCALTOP\typeout{*********** etocx.sty counter 0}%????
\section*{Part contents}%
  \or\typeout{*********** etocx.sty counter 1}%????
\subsection*{Chapter contents}%
  \or\typeout{*********** etocx.sty counter 2}%????
\XEtocheader*{Section contents}%
  \or\typeout{*********** etocx.sty counter 3}%????
\XEtocheader*{Subsection contents}%
  \or\typeout{*********** etocx.sty counter 4}%????
\XEtocheader*{Subsubsection contents}%
  \or%empty
  \or%empty
  \else\typeout{*********** etocx.sty counter ELSE}%????
\XetocHead%
  \fi\par}{\bigskip\noindent}
\fi%end-case of how deep


% override any minitoc commands to instead invoke etocs
\AtBeginDocument{%
\let\secttoc\localtableofcontents
\let\minitoc\localtableofcontents
\let\parttoc\localtableofcontents
\let\doparttoc\relax
\let\dominitoc\relax
\let\dosecttoc\relax
}
